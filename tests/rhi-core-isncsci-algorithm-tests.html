<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <script src="isncsci-tests-1.js"></script>
    <script src="../../../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <script src="../../../bower_components/web-component-tester/browser.js"></script>
    <link rel="import" href="../rhi-core-isncsci-algorithm.html"/>
    <link rel="import" href="../rhi-core-isncsci-binary-observation.html"/>
</head>
<body>
    <rhi-core-isncsci-algorithm id="isncsciAlgorithm"></rhi-core-isncsci-algorithm>
    <script>
        /* global assert Polymer rhiIsncsciValidationTests */
        // Loaded from isncsci-tests.js to keep this file clean.
        'use strict';
        
        suite('<rhi-core-isncsci-algorithm>', function() {
            var isncsciAlgorithm = document.getElementById('isncsciAlgorithm');
            
            test('Can calculate the totals for test at [index]', function() {
                // Arrange
                var test = rhiIsncsciValidationTests.all[0];
                var expectedTotals = test.totals;
                var isncsciExam = /** @type {!RhiCoreIsncsciExam} */ (document.createElement('rhi-core-isncsci-exam'));
                _bind(isncsciExam, test);
                
                // Act
                var totals = isncsciAlgorithm.getTotalsFor(isncsciExam);
                
                // Assert
                compare(expectedTotals, totals);
            });
            
            test('Can calculate the totals for the entire test suite', function () {
                // Arrange
                var tests = rhiIsncsciValidationTests.all;
                var testsLength = tests.length;
                
                // Act - Assert
                for (var i=0; i<testsLength; i++) {
                    var test = tests[i];
                    var isncsciExam = /** @type {!RhiCoreIsncsciExam} */ (document.createElement('rhi-core-isncsci-exam'));
                    _bind(isncsciExam, test);
                    var totals = isncsciAlgorithm.getTotalsFor(isncsciExam);
                    
                    console.log(i + '. ' + test.comments);
                    compare(test.totals, totals);
                }
            });
        });
        
        function compare (expectedTotals, totals) {
            assert.equal(expectedTotals.asiaImpairmentScale, totals.getAsiaImpairmentScaleValues(), 'asiaImpairmentScale');
            
            assert.equal(expectedTotals.leftLowerMotorContainsNt, totals.leftLowerMotorContainsNt, 'leftLowerMotorContainsNt');
            assert.equal(expectedTotals.leftLowerMotorTotal, totals.leftLowerMotorTotal, 'leftLowerMotorTotal');
            assert.equal(expectedTotals.leftMotor, _getValuesString(totals.getLeftMotorValues()), 'leftMotor');
            assert.equal(expectedTotals.leftMotorTotal, totals.leftUpperMotorTotal + totals.leftLowerMotorTotal, 'leftMotorTotal');
            assert.equal(expectedTotals.leftMotorZpp, _getValuesString(totals.getLeftMotorZppValues()), 'leftMotorZpp');
            assert.equal(expectedTotals.leftPrickContainsNt, totals.leftPrickContainsNt, 'leftPrickContainsNt');
            assert.equal(expectedTotals.leftPrickTotal, totals.leftPrickTotal, 'leftTouchTotal');
            assert.equal(expectedTotals.leftSensory, _getValuesString(totals.getLeftSensoryValues()), 'leftSensory');
            assert.equal(expectedTotals.leftSensoryZpp, _getValuesString(totals.getLeftSensoryZppValues()), 'leftSensoryZpp');
            assert.equal(expectedTotals.leftTouchContainsNt, totals.leftTouchContainsNt, 'leftTouchContainsNt');
            assert.equal(expectedTotals.leftTouchTotal, totals.leftTouchTotal, 'leftTouchTotal');
            assert.equal(expectedTotals.leftUpperMotorContainsNt, totals.leftUpperMotorContainsNt, 'leftUpperMotorContainsNt');
            assert.equal(expectedTotals.leftUpperMotorTotal, totals.leftUpperMotorTotal, 'leftUpperMotorTotal');
            
            assert.equal(expectedTotals.lowerMotorTotal, totals.lowerMotorTotal, 'lowerMotorTotal');
            assert.equal(expectedTotals.neurologicalLevelOfInjury, _getValuesString(totals.getNeurologicalLevelsOfInjury()), 'neurologicalLevelOfInjury');
            assert.equal(expectedTotals.prickTotal, totals.prickTotal, 'prickTotal');
            
            assert.equal(expectedTotals.rightLowerMotorContainsNt, totals.rightLowerMotorContainsNt, 'rightLowerMotorContainsNt');
            assert.equal(expectedTotals.rightLowerMotorTotal, totals.rightLowerMotorTotal, 'rightLowerMotorTotal');
            assert.equal(expectedTotals.rightMotor, _getValuesString(totals.getRightMotorValues()), 'rightMotor');
            assert.equal(expectedTotals.rightMotorTotal, totals.rightUpperMotorTotal + totals.rightLowerMotorTotal, 'rightMotorTotal');
            assert.equal(expectedTotals.rightMotorZpp, _getValuesString(totals.getRightMotorZppValues()), 'rightMotorZpp');
            assert.equal(expectedTotals.rightPrickContainsNt, totals.rightPrickContainsNt, 'rightPrickContainsNt');
            assert.equal(expectedTotals.rightPrickTotal, totals.rightPrickTotal, 'rightPrickTotal');
            assert.equal(expectedTotals.rightSensory, _getValuesString(totals.getRightSensoryValues()), 'rightSensory');
            assert.equal(expectedTotals.rightSensoryZpp, _getValuesString(totals.getRightSensoryZppValues()), 'rightSensoryZpp');
            assert.equal(expectedTotals.rightTouchContainsNt, totals.rightTouchContainsNt, 'rightTouchContainsNt');
            assert.equal(expectedTotals.rightTouchTotal, totals.rightTouchTotal, 'rightTouchTotal');
            assert.equal(expectedTotals.rightUpperMotorContainsNt, totals.rightUpperMotorContainsNt, 'rightUpperMotorContainsNt');
            assert.equal(expectedTotals.rightUpperMotorTotal, totals.rightUpperMotorTotal, 'rightUpperMotorTotal');
            
            assert.equal(expectedTotals.touchTotal, totals.touchTotal);
            assert.equal(expectedTotals.upperMotorTotal, totals.upperMotorTotal);
            
        }
        
        function _bind(isncsciExam, test) {
            var keys = ['C2', 'C3', 'C4', 'C5', 'C6', 'C7', 'C8',
                        'T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12',
                        'L1', 'L2', 'L3', 'L4', 'L5', 'S1', 'S2', 'S3', 'S4_5'];
            var dermatomes = test.dermatomes;
            isncsciExam.analContraction = _getBinaryObservationFor(test.analContraction);
            isncsciExam.analSensation = _getBinaryObservationFor(test.analSensation);
            
            for (var i=0; i<keys.length; i++) {
                var key = keys[i];
                var dermatome = dermatomes[key];
                isncsciExam.updateLevelAt(key, dermatome.rightTouch, dermatome.leftTouch, dermatome.rightPrick, dermatome.leftPrick, dermatome.rightMotor, dermatome.leftMotor);
            }
        }
        
        function _getBinaryObservationFor(value) {
            var valueToLower = value ? value.toLowerCase() : 'none';
                
            if (valueToLower === 'yes')
                return Polymer.rhiCoreIsncsciBinaryObservationYes;
                
            if (valueToLower === 'no')
                return Polymer.rhiCoreIsncsciBinaryObservationNo;
                
            if (valueToLower === 'nt')
                return Polymer.rhiCoreIsncsciBinaryObservationNt;
            
            return Polymer.rhiCoreIsncsciBinaryObservationNone;
        }
        
        function _getValuesString(values) {
            var result = '';
            
            for (var i=0; i<values.length; i++) {
                result += i > 0 ? ',' + values[i].name : values[i].name;
            }
            
            return result;
        }
    </script>
</body>
</html>